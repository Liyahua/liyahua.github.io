<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Linux内核升级 | Leoli&#39;s  blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="显示全文：">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux内核升级">
<meta property="og:url" content="http://www.stackops.info/2015/09/13/Linux内核升级/index.html">
<meta property="og:site_name" content="Leoli's  blog">
<meta property="og:description" content="显示全文：">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/drop_caches.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/uname.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/ls.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/看.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/k1.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/k2.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/k3.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/config.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/config2.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/k4.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/k5.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/k6.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/k7.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/make1.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/make2.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/bz.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/err.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/ln.png">
<meta property="og:image" content="http://7xl5dz.com1.z0.glb.clouddn.com/make2.png">
<meta property="og:updated_time" content="2015-09-13T04:16:00.824Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux内核升级">
<meta name="twitter:description" content="显示全文：">
  
    <link rel="alternative" href="/atom.xml" title="Leoli&#39;s  blog" type="application/atom+xml">
  
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
<script type="text/javascript">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?d1a0120d84ac9dc6082c5423dec3ef3d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</script>


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Leoli&#39;s  blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Follow your heart</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.stackops.info"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Linux内核升级" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/13/Linux内核升级/" class="article-date">
  <time datetime="2015-09-13T02:01:52.000Z" itemprop="datePublished">2015-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Linux内核升级
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>显示全文：<br><a id="more"></a></p>
<h2 id="Linux内核的简介：">Linux内核的简介：</h2><p>linux操作系统是一个用来和硬件打交道同时为用户程序提供一个有限服务集的低级支撑软件。内核提供了底层硬件的驱动，以及提供各种系统所需的核心功能，包括防火墙机制，是否支持LVM或Quota等文件系统等。</p>
<h2 id="为什么要进行linux内核的升级？">为什么要进行linux内核的升级？</h2><p>大部分情况下，我们可以不对内核进行太大改变，直接使用现有的内核，因为它已经可以提供给我们基本的功能，但现在的硬件升级速度太快了，如果核心太老，而机器又换了新的硬件，那么这个核心肯定是无法支持，当然我们也可以将新硬件的驱动做成模块化安装，现实情况也是这么做的。但我们不可能把内核所有支持的功能都编译进内核来支持所有硬件运行工作。我们可以通过编译内核，针对linux的用途加载不同的功能，让linux跑的更稳定，更流畅，这也是我们要编译核心的最主要原因。</p>
<h3 id="内核的两个模块：">内核的两个模块：</h3><pre><code>核心  ：<span class="regexp">/boot/</span>vmlinuz-version
内核模块: <span class="regexp">/lib/m</span>odules<span class="regexp">/version/</span>
</code></pre><h3 id="内核设计的两种风格：">内核设计的两种风格：</h3><pre><code>单内核：linux（采用微内核的设计思想，引用模块化设计）。

微内核：在微内核中，大部分内核都作为单独的进程在特权状态下运行，他们通过消息传递进行通讯。
</code></pre><h5 id="linux下装载模块的命令：">linux下装载模块的命令：</h5><pre><code><span class="title">insmod</span>
modprobe
</code></pre><h5 id="linux下查看当前系统的内核版本">linux下查看当前系统的内核版本</h5><pre><code><span class="attr_selector">[root@www boot]</span># <span class="tag">uname</span> <span class="tag">-r</span>
2<span class="class">.6</span><span class="class">.32-431</span><span class="class">.el6</span><span class="class">.x86_64</span>
主 次 修正  次修正号
</code></pre><p>次版本号为偶数表示稳定版，<br>修正：修正bug<br>次修正：添加新特性。</p>
<p>用户空间的访问，监控内核的方式：<br>/proc, /sys<br>伪文件系统。（是内核参数）<br>/proc/sys：此目录中的文件很多是可读写的。修改文件内容来修改内核运行特性。<br>例如：</p>
<pre><code>[root@localhost vm]<span class="preprocessor"># pwd</span>
/proc/sys/vm
[root@localhost vm]<span class="preprocessor"># ls -l</span>
total <span class="number">0</span>
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> block_dump
--w------- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> compact_memory
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> dirty_background_bytes
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> dirty_background_ratio
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> dirty_bytes
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> dirty_expire_centisecs
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> dirty_ratio
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> dirty_writeback_centisecs
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> drop_caches
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> extfrag_threshold
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> hugepages_treat_as_movable
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> hugetlb_shm_group
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> laptop_mode
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> legacy_va_layout
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> lowmem_reserve_ratio
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> max_map_count
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> memory_failure_early_kill
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> memory_failure_recovery
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> min_free_kbytes
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> min_slab_ratio
-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> Sep <span class="number">13</span> <span class="number">12</span>:<span class="number">08</span> min_unmapped_ratio
</code></pre><p>这些都是内核参数，作为管理员，可以进行内核参数的修改。<br>/sys/某些文件可写。<br>例如：通过修改内核参数/proc/sys/vm/drop_caches为，可以清空buffer。</p>
<p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/drop_caches.png" alt="drop_cache"></p>
<p><strong>注意</strong>：<br>    设定内核参数值的方法不能用vim而用echo重定向：</p>
<pre><code>#echo   VALUE  &gt;  <span class="regexp">/proc /</span>sys<span class="regexp">/TO/</span>SOMEFILE
</code></pre><p>例如: 我们想修改hostname主机名</p>
<h4 id="方法一：直接用echo修改内核的参数。">方法一：直接用echo修改内核的参数。</h4><pre><code>[root@localhost kernel]<span class="comment"># pwd</span>
/<span class="keyword">proc</span>/sys/kernel
[root@localhost kernel]<span class="comment"># cat hostname </span>
localhost.localdomain
[root@localhost kernel]<span class="comment"># hostname </span>
localhost.localdomain
[root@localhost kernel]<span class="comment"># echo leo &gt; hostname</span>
[root@localhost kernel]<span class="comment"># hostname</span>
leo
</code></pre><h4 id="方法二：使用sysctl控制">方法二：使用sysctl控制</h4><pre><code><span class="comment">#sysctl   -w  kernel.hostname="localhost.localdomain"</span>

使用<span class="string">"."</span>指定路径。文件必须是在/<span class="keyword">proc</span>/sys目录下的子目录里。
[root@localhost kernel]<span class="comment"># hostname </span>
leo
[root@localhost kernel]<span class="comment"># sysctl -w kernel.hostname=localhost.localdomain</span>
kernel.hostname = localhost.localdomain
[root@localhost kernel]<span class="comment"># hostname</span>
localhost.localdomain
</code></pre><p><strong>但是这两种方法都是立即生效的，但是不能永久生效</strong>。</p>
<p>想永久生效的话：唯一的办法是修改<strong>/etc/sysctl.conf</strong>（但不能立即生效）内核参数根据/etc/sysctl.conf这个文件设置内核参数的值。<br>写法：</p>
<pre><code><span class="title">sysctl</span>   -w  kernel.hostname=<span class="string">"localhost.localdomain"</span>
</code></pre><p>例如：<br>两块网卡，是否允许在两块网卡之间传递包。</p>
<pre><code>[root<span class="constant">@localhost</span> ~]<span class="preprocessor"># cat /proc/sys/net/ipv4/ip_forward </span>
<span class="number">0</span> 
</code></pre><p>1代表传递，0代表不传递。</p>
<p>通过修改/etc/sysctl.conf 这个文件，将0改为1，即可永久生效，但是不会立即生效、</p>
<pre><code>[root@localhost ~]<span class="preprocessor"># head /etc/sysctl.conf </span>
<span class="preprocessor"># Kernel sysctl configuration file for Red Hat Linux</span>
<span class="preprocessor">#</span>
<span class="preprocessor"># For binary values, <span class="number">0</span> is disabled, <span class="number">1</span> is enabled.  See sysctl(<span class="number">8</span>) and</span>
<span class="preprocessor"># sysctl.conf(<span class="number">5</span>) for more details.</span>

<span class="preprocessor"># Controls IP packet forwarding</span>
net.ipv4.ip_forward = <span class="number">1</span>

<span class="preprocessor"># Controls source route verification</span>
net.ipv4.conf.<span class="keyword">default</span>.rp_filter = <span class="number">1</span>
</code></pre><p>或者，我们可以通过命令</p>
<pre><code><span class="id">#sysctl</span>  -<span class="tag">p</span>  
</code></pre><p>让内核重读这个文件，实现立即生效。</p>
<pre><code>[root@localhost ~]<span class="preprocessor"># sysctl -p</span>
net.ipv4.ip_forward = <span class="number">1</span>
net.ipv4.conf.<span class="keyword">default</span>.rp_filter = <span class="number">1</span>
net.ipv4.conf.<span class="keyword">default</span>.accept_source_route = <span class="number">0</span>
kernel.sysrq = <span class="number">0</span>
kernel.core_uses_pid = <span class="number">1</span>
net.ipv4.tcp_syncookies = <span class="number">1</span>
error: <span class="string">"net.bridge.bridge-nf-call-ip6tables"</span> is an unknown key
error: <span class="string">"net.bridge.bridge-nf-call-iptables"</span> is an unknown key
error: <span class="string">"net.bridge.bridge-nf-call-arptables"</span> is an unknown key
kernel.msgmnb = <span class="number">65536</span>
kernel.msgmax = <span class="number">65536</span>
kernel.shmmax = <span class="number">68719476736</span>
kernel.shmall = <span class="number">4294967296</span>


<span class="preprocessor">#sysctl  -a  ：显示所有的内核参数和其值。</span>
</code></pre><p>常用的三个参数：<strong>hostname</strong>，<strong>ip_forward</strong>，<strong>/proc/sys/vm/drop_caches</strong></p>
<p>内核模块管理：</p>
<p>lsmod：列出当前内核装载的模块。</p>
<pre><code>[root@localhost kernel]<span class="preprocessor"># lsmod </span>
Module                  Size  Used by
ipv6                  <span class="number">321747</span>  <span class="number">266</span> 
nls_utf8                <span class="number">1421</span>  <span class="number">1</span> 
dm_mirror              <span class="number">14048</span>  <span class="number">0</span> 
dm_region_hash         <span class="number">10730</span>  <span class="number">1</span> dm_mirror
dm_log                  <span class="number">9696</span>  <span class="number">2</span> dm_mirror,dm_region_hash
snd_ens1371            <span class="number">20593</span>  <span class="number">0</span> 
snd_rawmidi            <span class="number">22734</span>  <span class="number">1</span> snd_ens1371
snd_ac97_codec        <span class="number">124339</span>  <span class="number">1</span> snd_ens1371
ac97_bus                <span class="number">1442</span>  <span class="number">1</span> snd_ac97_codec
snd_seq                <span class="number">55532</span>  <span class="number">0</span> 
snd_seq_device          <span class="number">6522</span>  <span class="number">2</span> snd_rawmidi,snd_seq
snd_pcm                <span class="number">85629</span>  <span class="number">2</span> snd_ens1371,snd_ac97_codec
snd_timer              <span class="number">21904</span>  <span class="number">2</span> snd_seq,snd_pcm
snd                    <span class="number">68480</span>  <span class="number">7</span> snd_ens1371,snd_rawmidi,snd_ac97_codec,snd_seq,snd_seq_device,
snd_pcm,snd_timersoundcore               <span class="number">7668</span>  <span class="number">1</span> snd
snd_page_alloc          <span class="number">8428</span>  <span class="number">1</span> snd_pcm
e1000                 <span class="number">145057</span>  <span class="number">0</span> 
floppy                 <span class="number">63253</span>  <span class="number">0</span> 
vmw_balloon             <span class="number">6781</span>  <span class="number">0</span> 
microcode             <span class="number">111822</span>  <span class="number">0</span> 
pcspkr                  <span class="number">1958</span>  <span class="number">0</span> 
i2c_piix4              <span class="number">10998</span>  <span class="number">0</span> 
i2c_core               <span class="number">30023</span>  <span class="number">1</span> i2c_piix4
shpchp                 <span class="number">27791</span>  <span class="number">0</span> 
sg                     <span class="number">29692</span>  <span class="number">0</span> 
dm_mod                 <span class="number">74380</span>  <span class="number">2</span> dm_mirror,dm_log
ext4                  <span class="number">364623</span>  <span class="number">1</span> 
mbcache                 <span class="number">7254</span>  <span class="number">1</span> ext4
jbd2                   <span class="number">80484</span>  <span class="number">1</span> ext4
sd_mod                 <span class="number">35179</span>  <span class="number">3</span> 
crc_t10dif              <span class="number">1531</span>  <span class="number">1</span> sd_mod
sr_mod                 <span class="number">15213</span>  <span class="number">1</span> 
cdrom                  <span class="number">39482</span>  <span class="number">1</span> sr_mod
mptspi                 <span class="number">16113</span>  <span class="number">2</span> 
mptscsih               <span class="number">34977</span>  <span class="number">1</span> mptspi
mptbase                <span class="number">93281</span>  <span class="number">2</span> mptspi,mptscsih
scsi_transport_spi     <span class="number">24957</span>  <span class="number">1</span> mptspi
pata_acpi               <span class="number">3691</span>  <span class="number">0</span> 
ata_generic             <span class="number">3891</span>  <span class="number">0</span> 
ata_piix               <span class="number">23068</span>  <span class="number">1</span> 


modprobe  MOD_NAME：模块装载。
modprobe  -r  MOD_NAME ：卸载模块。
modinfo  MOD_NAME：查看模块的具体信息
另两个命令：但这里必须指定模块路径。
insmod  /path/to/module_file：装载模块（必须指定模块的路径）。
rmmod    MOD_NAME:卸载模块（移除）
depmod  /path/to/modiles_dir   生成模块依赖。。。（需要指定路径）
内核模块必须和驱动程序完全相同。
</code></pre><p>内核中的功能除了核心功能之外，在编译时，大多数功能都要有三种选择：</p>
<ul>
<li>1，<strong>不使用此功能</strong></li>
<li>2，<strong>编译成内核模块   modprobe装载</strong>，</li>
<li>3，<strong>编译进内核</strong>。</li>
</ul>
<p>##如何手动编译内核：</p>
<p>目前内核版本是：<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/uname.png" alt="uname"></p>
<p>挂载系统镜像光驱到/mnt目录，创建一个rpm仓库，编辑yum的配置文件：</p>
<ul>
<li>1）， cd /etc/yum.repos.d目录下，创建一个.repo的文件。内容如下：</li>
</ul>
<pre><code><span class="title">[root@localhost ~]</span><span class="comment"># cat /etc/yum.repos.d/Base.repo </span>
<span class="title">[base]</span>
<span class="setting">name=<span class="value">Server</span></span>
<span class="setting">baseurl=<span class="value">file:///mnt</span></span>
<span class="setting">enabled=<span class="value"><span class="number">1</span></span></span>
<span class="setting">gpgcheck=<span class="value"><span class="number">0</span></span></span>
</code></pre><ul>
<li>2)，编辑/etc/fstab，使得系统光驱开机自动挂载，搭建一个本地的yum仓库。</li>
</ul>
<pre><code>[root@localhost ~]<span class="comment"># cat /etc/fstab </span>

<span class="comment">#</span>
<span class="comment">#/etc/fstab</span>
<span class="comment">#Created by anaconda on Sat Sep 12 10:59:40 2015</span>
<span class="comment">#</span>
<span class="comment">#Accessible filesystems, by reference, are maintained under '/dev/disk'</span>
<span class="comment">#See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span>
<span class="comment">#</span>
<span class="type">UUID</span>=<span class="number">8</span>ebb2c3a-<span class="number">320</span>d-<span class="number">40</span>fb-<span class="number">8</span>d57-<span class="number">062</span>be9556d46 /                       ext4    defaults        <span class="number">1</span> <span class="number">1</span>
<span class="type">UUID</span>=<span class="number">6499</span>e7e6-a462-<span class="number">4</span>b30-b195-<span class="number">1</span>bca6ee04eaa swap                    swap    defaults        <span class="number">0</span> <span class="number">0</span>
tmpfs                   /dev/shm                tmpfs   defaults        <span class="number">0</span> <span class="number">0</span>
devpts                  /dev/pts                devpts  gid=<span class="number">5</span>,mode=<span class="number">620</span>  <span class="number">0</span> <span class="number">0</span>
sysfs                   /sys                    sysfs   defaults        <span class="number">0</span> <span class="number">0</span>
<span class="keyword">proc</span>                    /<span class="keyword">proc</span>                   <span class="keyword">proc</span>    defaults        <span class="number">0</span> <span class="number">0</span>
**/dev/cdrom               /mnt            iso9660 defaults        <span class="number">0</span> <span class="number">0</span>**
</code></pre><p>只需要添加最后一行即可。</p>
<ul>
<li>3)，安装需要用到的开发库：</li>
</ul>
<pre><code><span class="title">yum</span> groupinstall <span class="string">"Development Tools"</span> <span class="string">"Development Libraries"</span> -y
</code></pre><p>可以通过命令  #yum  grouplist 查看当前系统哪些库装了，哪些没安装，依据自己实际情况而定。</p>
<ul>
<li>4),将下载的内核解压到/usr/src这个目录下。<br>下载内核链接：www.kernel.org</li>
</ul>
<pre><code><span class="id">#tar</span> -xvf linux-<span class="number">2.6</span>.<span class="number">38.2</span><span class="class">.tar</span><span class="class">.xz</span> -C /usr/src/
</code></pre><p>创建一个软连接，当前我们使用的内核或正在编译的内核一般链接为linux</p>
<pre><code><span class="id">#ln</span> -sv linux-<span class="number">2.6</span>.<span class="number">38.2</span> linux
`linux<span class="string">' -&gt; `linux-2.6.38.2'</span>
</code></pre><p>查看linux目录下的文件：<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/ls.png" alt="ls"></p>
<p>可以看到有很多的子目录：<br>例如：</p>
<pre><code>arch：架构有关。
crypto：加密解密
drivers：驱动
<span class="built_in">fs</span>：文件系统，里面包括ntfs，默认没有安装这个模块，我们可以安装。这样双系统就可以共享文件。
virt：虚拟化功能
ipc：进程间通信
firmware：固件
Documentation：文档。
</code></pre><h2 id="如何手动编译内核呢：">如何手动编译内核呢：</h2><ul>
<li><p>1），make gconfig :  Gnome桌面环境使用（需要安装图形开发库）GNOME  Software  Development<br>make  kconfig：KDE桌面环境使用；需要安装图形开发库）<br>需要安装桌面，用的不是特别多，用的更多是下面哪种方法。</p>
</li>
<li><p>2），使用menuconfig这个命令之前要先将开发库安装好。</p>
</li>
</ul>
<pre><code><span class="id">#yum</span> -y install ncurses-devel
<span class="id">#make</span>  menuconfig 
</code></pre><p>打开文本菜单（需要在内核所在的目录输入该命令）。勾选内核属性。我们可以将当前系统的内核配置文件拷备过去，然后在当前系统内核配置文件的基础上做修改。</p>
<ul>
<li>3），make编译。<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/看.png" alt="k1"></li>
</ul>
<p>可以看到选择的界面，注意—-&gt;表示底下有很多子条目。敲回车即可打开子条目。<br>    [*]：表示做进内核中<br>    [M]：表示做成模块<br>    [  ]：表示不启用此功能。</p>
<p>在General  setup的子目录下，有个叫做local   version的选项，就是本地版本号<br>例如：<br>    [root@www boot]# uname -r<br>    2.6.32-431.el6.x86_64<br>这里的431就是本地版本号，我们可以自己定义。<br>在local version那个选项那里回车即可输入自己编译的版本号。<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/k1.png" alt="k1"><br>连敲两下esc可以退到上一层目录。</p>
<p>在出现的界面中我们可以选择文件系统的选项，可以将NTFS这个功能做成模块。这样如果电脑装了双系统，linux系统也可以访问windows的NTFS文件系统下的文件。</p>
<p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/k2.png" alt="k2"></p>
<p>然后选好自己想要安装的内核功能，然后保存配置文件。</p>
<p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/k3.png" alt="k3"></p>
<p>点击yes退出，就会在内核编译的目录下生成一个隐藏配置文件.config，</p>
<p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/config.png" alt="config"></p>
<p>我们当前运行的系统也存在一个内核的配置文件，在/boot目录下，</p>
<p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/config2.png" alt="config2"></p>
<p>我们自己定义的config可能在编译的过程中发生错误而导致编译不成功。为了减小这种错误，我们可以将目前系统的内核配置文件复制过去，然后再在当前配置文件的基础上进行修改，这样出现问题的几率就会小很多。<br>例如：<br>    我们新下载的一个内核，进行编译的时候，先将目前内核的配置文件复制到内核文件所在目录下命名为.config，然后执行make  menuconfig这个命令，根据自己的需求进行修改。这样出现问题的可能性会降小。</p>
<p>对内核进行一些调整：</p>
<p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/k4.png" alt="k4"></p>
<p>选中项定义了处理器的类型和特点，我们可以进行选择，去掉一些不常用的功能。<br>centos和redhat默认的cpu类型都是选择的Generic-x86-64，我们可以依据自己的实际情况选择，例如我自己的笔记本是core i5的就可以将处理器选择为core2的。</p>
<p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/k5.png" alt="k5"><br>同时我们可以去掉一些内核的驱动，一些很老，没必要使用的驱动。<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/k6.png" alt="k6"><br>例如网卡驱动：</p>
<p>几个比较古老已经淘汰了的东西：<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/k7.png" alt="k7"></p>
<p>上面的PCMCIA,ATM,FDDI都已经淘汰，用不到，可以去掉了。</p>
<ul>
<li>4），make安装：</li>
</ul>
<p>make  进行编译内核。可能会经历很长时间。</p>
<p>可以使用</p>
<pre><code><span class="id">#make</span>  -j4   
</code></pre><p>同时使用4核来进行编译加快速度，具体根据自己的机器核心数来指定-j后的number。</p>
<p>make编译安装之后会生成vmlinux,System.map ,modules.builtin等文件。</p>
<pre><code><span class="id">#make</span>  modules_install  -j4  先进行模块安装，再安装。
</code></pre><p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/make1.png" alt="make1"></p>
<pre><code><span class="id">#make</span>   install  -j4  安装。
</code></pre><p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/make2.png" alt="make2"></p>
<p>至此，编译系统编译安装完成。</p>
<p>如果之前的编译不好用，可以进行编译清理。<br>二次编译时清理：（清理前，如果有需要，请备份配置文件.config）<br>    make  clean：清理此前编译好的二进制模块。<br>    make    mrproper：清理此前编译的内容，使用之前，最好先备份配置文件.config）。</p>
<p>内核编译完成之后，会在 /usr/src/linux/arch/x86/boot目录下生成一个bzImage，这是linux内核的映像文件。<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/bz.png" alt="bz"></p>
<p>内核编译完成后我们可以通过修改/boot/grub/grub.conf这个grub的配置文件进行内核选择，从新的内核启动。<br>    [root@localhost ~]# cat /boot/grub/grub.conf </p>
<pre><code><span class="preprocessor">#grub.conf generated by anaconda</span>
<span class="preprocessor">#</span>
<span class="preprocessor">#Note that you do not have to rerun grub after making changes to this file</span>
<span class="preprocessor">#NOTICE:  You do not have a /boot partition.  This means that</span>
<span class="preprocessor">#          all kernel and initrd paths are relative to /, eg.</span>
<span class="preprocessor">#          root (hd0,<span class="number">1</span>)</span>
<span class="preprocessor">#          kernel /boot/vmlinuz-version ro root=/dev/sda2</span>
<span class="preprocessor">#          initrd /boot/initrd-[generic-]version.img</span>
<span class="preprocessor">#boot=/dev/sda</span>
<span class="keyword">default</span>=<span class="number">0</span>
timeout=<span class="number">5</span>
splashimage=(hd0,<span class="number">1</span>)/boot/grub/splash.xpm.<span class="function">gz
hiddenmenu
title <span class="title">CentOS</span> <span class="params">(<span class="number">2.6</span><span class="number">.38</span><span class="number">.2</span>-<span class="number">1.</span>el6)</span>
    <span class="title">root</span> <span class="params">(hd0,<span class="number">1</span>)</span>
    kernel /boot/vmlinuz-2.6.38.2-1.el6 ro root</span>=UUID=<span class="number">8</span>ebb2c3a-<span class="number">320</span>d-<span class="number">40f</span>b-<span class="number">8</span>d57-<span class="number">062</span>be9556d46 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-<span class="number">8</span> rd_NO_MD SYSFONT
=latarcyrheb-sun16 crashkernel=<span class="keyword">auto</span>  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet    initrd /boot/initramfs-<span class="number">2.6</span><span class="number">.38</span><span class="number">.2</span>-<span class="number">1.</span>el6.img
title CentOS <span class="number">6</span> (<span class="number">2.6</span><span class="number">.32</span>-<span class="number">504.</span>el6.x86_64)
    root (hd0,<span class="number">1</span>)
    kernel /boot/vmlinuz-<span class="number">2.6</span><span class="number">.32</span>-<span class="number">504.</span>el6.x86_64 ro root=UUID=<span class="number">8</span>ebb2c3a-<span class="number">320</span>d-<span class="number">40f</span>b-<span class="number">8</span>d57-<span class="number">062</span>be9556d46 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-<span class="number">8</span> rd_NO_MD 
SYSFONT=latarcyrheb-sun16 crashkernel=<span class="keyword">auto</span>  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet    initrd /boot/initramfs-<span class="number">2.6</span><span class="number">.32</span>-<span class="number">504.</span>el6.x86_64.img
</code></pre><p>如图，只需要将default=1改为default=0即可，即从第一个内核vmlinuz-2.6.38.2-1.el6启动。</p>
<p>解释下各参数的含义：<br>    default=0:设定默认启动的title的编号，从0开始<br>    timeout=5  ：等待用户选择超时时长，单位为s<br>    splashimage=(hd0,0)/grub/splash.xpm.gz：grub的背景图片<br>    hiddenmenu：隐藏菜单。<br>    title Red Hat Enterprise Linux (2.6.32-358.el6.i686)   内核标题或操作系统标题。字符串，可以自由修改。<br>    root (hd0,1)#内核文件所在的设备。（对grub而言，所有类型硬盘一律为hd；格式为（hd#,N)  hd#表示第#个磁盘。最后的0则表示对应的磁盘分区。<br>        kernel /vmlinuz-2.6.32-358.el6.i686 ro #grub的访问路径所以是在根下。<br>        root=UUID=1e0664cd-aaf4-4064-96b5-3090c26f37a0 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT<br>    =latarcyrheb-sun16 crashkernel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</p>
<pre><code><span class="preprocessor">#内核文件路径。</span>
initrd /initramfs-<span class="number">2.6</span><span class="number">.32</span>-<span class="number">358.</span>el6.i686.img <span class="preprocessor">#ramdisk的文件路径。</span>
</code></pre><p>重启系统后，查看内核是否完成升级</p>
<pre><code>[root@localhost ~]<span class="preprocessor"># uname -r</span>
<span class="number">2.6</span><span class="number">.38</span><span class="number">.2</span>-<span class="number">1.</span>el6
</code></pre><p>可以看到内核已经从2.6.32升级到2.6.38了。</p>
<h2 id="可能遇到的问题：">可能遇到的问题：</h2><p>使用vmware进行编译内核的时候，执行到make install时候会提示如下错误，意思是vmware_balloon这个模块找不到，原因是这个模块名字已经发生了改变为vmw_balloon.ko。做个软连接即可。<br>错误提示：<br><img src="http://7xl5dz.com1.z0.glb.clouddn.com/err.png" alt="err"></p>
<p>找不到 vmware_balloon 模块，原因有两个：<br>首先，确认你的 .config 文件里面有  CONFIG_VMWARE_BALLOON=m 这一行，或者你可以用 make menuconfig 进去内核编译菜单，选中 Device Drivers -&gt; MISC devices -&gt; VMware Balloon Driver 为 M 或者 *<br>其次，而这个模块在后面的版本中，已经更名为 vmw_balloon，所以 可以用下面的命令来解决：<br>cd /lib/modules/3.x.xx/kernel/drivers/misc #将版本号改成你自己的<br>ln -s vmw_balloon.ko vmware_balloon.ko #建立软连接</p>
<h4 id="解决方法：">解决方法：</h4><p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/ln.png" alt="ln"></p>
<h4 id="成功编译：">成功编译：</h4><p><img src="http://7xl5dz.com1.z0.glb.clouddn.com/make2.png" alt="make2"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.stackops.info/2015/09/13/Linux内核升级/" data-id="cig1hz8ti0028f87bwbq31ijo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/09/14/bash编程-斐波那契序列/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          bash编程-斐波那契序列
        
      </div>
    </a>
  
  
    <a href="/2015/08/20/OpenStack搭建09-实例创建/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">OpenStack搭建09-实例创建</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-Linux内核升级" data-title="Linux内核升级" data-url="http://www.stackops.info/2015/09/13/Linux内核升级/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'leoli'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
  </section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AMQP/">AMQP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cisco/">Cisco</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Etherchannel/">Etherchannel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fibonacci-Sequence/">Fibonacci Sequence</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keystone/">Keystone</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NTP/">NTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NetEase/">NetEase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenStack/">OpenStack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RSTP/">RSTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/">bash</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/compute/">compute</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dashboard/">dashboard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/expand/">expand</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/free/">free</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glance/">glance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/image/">image</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nova/">nova</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nova-network/">nova-network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openstack/">openstack</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/portfast/">portfast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/submin/">submin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/">svn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/switch/">switch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/top/">top</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vmstat/">vmstat</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AMQP/" style="font-size: 10px;">AMQP</a> <a href="/tags/Cisco/" style="font-size: 10px;">Cisco</a> <a href="/tags/Etherchannel/" style="font-size: 10px;">Etherchannel</a> <a href="/tags/Fibonacci-Sequence/" style="font-size: 10px;">Fibonacci Sequence</a> <a href="/tags/Keystone/" style="font-size: 10px;">Keystone</a> <a href="/tags/NTP/" style="font-size: 10px;">NTP</a> <a href="/tags/NetEase/" style="font-size: 10px;">NetEase</a> <a href="/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/tags/RSTP/" style="font-size: 10px;">RSTP</a> <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/compute/" style="font-size: 13.33px;">compute</a> <a href="/tags/dashboard/" style="font-size: 10px;">dashboard</a> <a href="/tags/expand/" style="font-size: 10px;">expand</a> <a href="/tags/free/" style="font-size: 10px;">free</a> <a href="/tags/glance/" style="font-size: 10px;">glance</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/image/" style="font-size: 10px;">image</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nova/" style="font-size: 10px;">nova</a> <a href="/tags/nova-network/" style="font-size: 10px;">nova-network</a> <a href="/tags/openstack/" style="font-size: 20px;">openstack</a> <a href="/tags/portfast/" style="font-size: 10px;">portfast</a> <a href="/tags/submin/" style="font-size: 10px;">submin</a> <a href="/tags/svn/" style="font-size: 10px;">svn</a> <a href="/tags/switch/" style="font-size: 10px;">switch</a> <a href="/tags/top/" style="font-size: 10px;">top</a> <a href="/tags/vmstat/" style="font-size: 10px;">vmstat</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">13</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/10/21/OpenStack搭建10-计算节点扩展/">OpenStack搭建10-计算节点扩展</a>
          </li>
        
          <li>
            <a href="/2015/09/22/Linux命令详解-top/">Linux命令详解-top</a>
          </li>
        
          <li>
            <a href="/2015/09/22/Linux命令详解-vmstat/">Linux命令详解-vmstat</a>
          </li>
        
          <li>
            <a href="/2015/09/21/网易互联网-系统运维工程师面试记/">网易互联网-系统运维工程师面试记</a>
          </li>
        
          <li>
            <a href="/2015/09/20/Linux命令详解-free/">Linux命令详解-free</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 liyahua<br>
       <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          <span id="busuanzi_container_site_pv">您是本站第<span id="busuanzi_value_site_pv"></span>位访客</span><br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
 </footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>